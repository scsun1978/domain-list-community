name: Build geosite.dat & geoip.dat

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4
        with:
          path: code

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: code/go.mod
          cache-dependency-path: code/go.sum

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zip xz-utils
          sudo apt-get install -y gnupg

      - name: Install GitHub CLI
        uses: cli/cli@v3
        
      - name: Set variables
        run: |
          echo "RELEASE_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          echo "TAG_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

      # ---- Build geosite.dat ----
      - name: Build geosite.dat
        run: |
          cd code
          go run ./ --outputdir=../output/geosite \
            --exportlists=category-ads-all,tld-cn,cn,tld-\!cn,geolocation-\!cn,apple,icloud
          ls ../output/geosite
        shell: bash

      # ---- Build geoip.dat (从 Loyalsoldier 方式) ----
      - name: Clone geoip repo
        run: |
          git clone https://github.com/Loyalsoldier/geoip.git geoip-src
          cd geoip-src
          sudo apt-get install -y python3 python3-pip
          pip3 install -r requirements.txt
          ./tools/convert.py --outputdir ../output/geoip
          ls ../output/geoip

      # ---- Package all ----
      - name: Generate checksums
        run: |
          cd output/geosite
          sha256sum geosite.dat > geosite.dat.sha256sum
          zip -9 geosite.dat.zip geosite.dat
          sha256sum geosite.dat.zip > geosite.dat.zip.sha256sum
          xz -z -9 -k geosite.dat
          sha256sum geosite.dat.xz > geosite.dat.xz.sha256sum

          cd ../geoip
          sha256sum geoip.dat > geoip.dat.sha256sum
          zip -9 geoip.dat.zip geoip.dat
          sha256sum geoip.dat.zip > geoip.dat.zip.sha256sum
          xz -z -9 -k geoip.dat
          sha256sum geoip.dat.xz > geoip.dat.xz.sha256sum

      # ---- Release ----
      - name: Create GitHub Release
        run: |
          gh release create "${TAG_NAME}" \
            --latest \
            --title "${RELEASE_NAME}" \
            --notes "Automated build of geosite.dat + geoip.dat" \
            ./output/geosite/geosite.dat \
            ./output/geosite/geosite.dat.sha256sum \
            ./output/geosite/geosite.dat.zip \
            ./output/geosite/geosite.dat.zip.sha256sum \
            ./output/geosite/geosite.dat.xz \
            ./output/geosite/geosite.dat.xz.sha256sum \
            ./output/geoip/geoip.dat \
            ./output/geoip/geoip.dat.sha256sum \
            ./output/geoip/geoip.dat.zip \
            ./output/geoip/geoip.dat.zip.sha256sum \
            ./output/geoip/geoip.dat.xz \
            ./output/geoip/geoip.dat.xz.sha256sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
